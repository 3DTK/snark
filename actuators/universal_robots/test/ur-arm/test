#!/bin/bash

config=config.json
prefix=ur5
publisher_address=$( name-value-get --from json $prefix/publisher/data/address < $config )
publisher_port=$( name-value-get --from json $prefix/publisher/data/port < $config )

bins=(run1.bin run2.bin run3.bin run4.bin run5.bin)
delay=0.25

function elapsed_time { echo "$( date +%s.%N ) - $start_time" | bc -l; }

for bin in ${bins[@]}; do
    start_time=$( date +%s.%N )
    while (( `echo "$( elapsed_time ) < $delay" | bc -l` )); do cat $bin; done
done | io-publish -s 812 tcp:$publisher_port 2>/dev/null &

keys=()
inputs=()
while IFS='=' read k i; do
    keys+=($k)
    inputs+=($i)
done

declare -i i=0
for input in ${inputs[@]}; do echo $input; done \
    | ur-arm wait --fields=command,values --config=$config --prefix=$prefix --timeout=5 --tolerance=0.001 \
    | while IFS= read output; do echo "${keys[$i]}/output=$output"; (( i++ )); done
